{
  "filename": "README.md",
  "content": "# ConveyorLine_Palletizer - README\n\n## Overview\n\nThis repository contains the PLC application for the ConveyorLine_Palletizer system implemented for Siemens S7-1500 (SCL). The implementation follows TIA Portal conventions: OB100 (cold start) for initialization and OB1 as the cyclic main task. Each Function Block (FB) has an Instance DB with a fixed explicit name (see Instance DB list below). UDTs (Device, Alarm, State) are provided and used throughout to ensure consistent diagnostics, HSBY packaging and SCADA exposure.\n\nThis document describes:\n- Project structure and responsibilities of each FB/UDT/OB\n- Required Instance DB names and their purpose\n- Step-by-step instructions to import the code into TIA Portal and compile\n- SCADA tag mapping overview showing direct PLC-to-SCADA connections\n- Notes on E-Stop behavior, reset permissives and recommended diagnostics\n\nAll tag, DB and block names in the sections below are authoritative and must be used as-is when creating instance DBs and SCADA mappings.\n\n---\n\n## Project structure (files and responsibilities)\n\nTop-level organization:\n- ob/\n  - OB100.scl       -> Cold-start initialization (OB100)\n  - OB1.scl         -> Cyclic master task (OB1)\n- fb/\n  - FB_ModeMgr.scl        -> Central mode manager (FB_ModeMgr)\n  - FB_Conveyor.scl       -> Conveyor zone control (FB_Conveyor)\n  - FB_MergeDivert.scl    -> Barcode-based merge/divert (FB_MergeDivert)\n  - FB_PalletizerHS.scl   -> Palletizer handshake state machine (FB_PalletizerHS)\n  - FB_AlarmMgr.scl       -> Central alarm manager (FB_AlarmMgr)\n  - FB_Diag.scl           -> Diagnostics and HSBY packaging (FB_Diag)\n  - FB_Comms.scl          -> Communications mapping (FB_Comms)\n- udt/\n  - UDT_Device.scl        -> Device UDT (DeviceID, Present, Health, etc.)\n  - UDT_Alarm.scl         -> Alarm DDT (Alarm_ID, Severity, Latched, etc.)\n  - UDT_State.scl         -> Global state/permissives UDT\n- docs/\n  - Scada_Tag_Map.md      -> Human-readable SCADA tag map (duplicated below)\n\nEach FB is intended to be instantiated once (unless system scaled). Each instance requires an Instance DB created explicitly with the exact name provided in the PLAN. Example Instance DBs are listed in the next section.\n\n---\n\n## FB responsibilities (summary)\n\n- FB_ModeMgr (fb/FB_ModeMgr.scl)\n  - Central mode state machine (RUN_AUTO, RUN_MANUAL, STOP, HSBY_WAIT, MAINTENANCE, SIMULATION, ESTOP)\n  - Evaluate permissives: PLC_Health_OK, Power_Supplies_OK, HotStandby_Link_OK_or_StandbyReady, No_High_Severity_SIF_Trip, Operator_Authorised, Maintenance_Permit, Simulation_Enabled_Bit\n  - Implement ESTOP logic: on ESTOP assert enforce safe outputs; require ResetPermissives input to be true and all permissives evaluated before allowing RUN_AUTO\n  - Publish mode and ModeChangeTimestamp\n\n- FB_Conveyor (fb/FB_Conveyor.scl)\n  - Control single conveyor zone with motor enable output\n  - Auto/manual control selection, manual drive permissive enforcement\n  - Jam detection (encoder & beam), soft/hard jam determination via timers\n  - Automatic clear-sequence (timed reverse/slow-forward) while safety interlocks permit\n  - Provide JamState and ClearSequenceActive outputs\n\n- FB_MergeDivert (fb/FB_MergeDivert.scl)\n  - Accept Barcode_DDT, validate checksum and schema\n  - Consult a routing table (on-local DB or in FB constants) and output RouteCmd\n  - When unreadable/unavailable, route to HOLD_LANE_01 and raise NONCRITICAL alarm, start fallback timer\n\n- FB_PalletizerHS (fb/FB_PalletizerHS.scl)\n  - Coordinate discrete handshake with palletizer (PalletReq, PalletAck, PalletReady)\n  - Implement request_ack_timeout_ms and transfer_complete_timeout_ms\n  - Retry/backoff logic and transition to FAULT on repeated failures\n  - Produce HandshakeState and TransferStartCmd and track LastError in DB\n\n- FB_AlarmMgr (fb/FB_AlarmMgr.scl)\n  - Centralize alarm collection, apply latching and ack behaviour\n  - Track ActiveAlarms array and FirstOutAlarm\n  - Support inhibit and shelving; prepare SCADA-ready arrays\n\n- FB_Diag (fb/FB_Diag.scl)\n  - Provide PLC heartbeat and diagnostic strings\n  - Pack IO module and remote rack status arrays for efficient SCADA polling\n  - Publish PLC application and library versions\n\n- FB_Comms (fb/FB_Comms.scl)\n  - Map selected PLC variables to Modbus TCP / OPC UA registers\n  - Provide SCADA read/write descriptors and BMENOC0321 MIB status\n  - Implement deterministic timeouts/retries for communications\n\n- UDT_Device, UDT_Alarm, UDT_State (udt/*.scl)\n  - Provide canonical structured types used throughout the FBs for consistent SCADA and HSBY packaging\n\n- OB100 (ob/OB100.scl)\n  - Cold-start initialization. Create and initialize global DBs and Instance DBs to safe default states, set outputs to safe state on ESTOP, publish versions and diagnostics\n\n- OB1 (ob/OB1.scl)\n  - Cyclic main task. Calls FB_ModeMgr first, then process FBs in safe order (Conveyor, MergeDivert, PalletizerHS), then FB_AlarmMgr, FB_Diag, FB_Comms. Exposes PLC_Heartbeat to SCADA.\n\n---\n\n## Instance DBs (exact names and purpose)\n\nCreate the following Instance DBs with the exact names shown. The Instance DB layout is defined inside each FB and uses the UDTs described in udt/*.scl.\n\n- DB_SystemConfig\n  - Global configuration (application-wide constants, network addresses, route tables if not external)\n  - Initialized by OB100\n\n- DB_ModeMgr\n  - Instance DB created by FB_ModeMgr (stores CurrentMode, permissives, ModeChangeTimestamp)\n\n- DB_Conveyor1\n  - Instance DB for the first conveyor FB_Conveyor invocation\n  - Contains MotorCmd, JamState, ClearSequenceActive, device UDTs, local timers and last-change timestamps\n\n- DB_MergeDivert1\n  - Instance DB for first merge/divert FB_MergeDivert\n  - Contains last barcode processed, RouteCmd, RouteStatus, fallback timer state\n\n- DB_PalletizerHS1\n  - Instance DB for FB_PalletizerHS first handshake instance\n  - Contains HandshakeState, last error string, watchdog counters, retry/backoff status\n\n- DB_AlarmMgr\n  - Instance DB created by FB_AlarmMgr\n  - Holds ActiveAlarms array and FirstOutAlarm and inhibit lists\n\n- DB_Diagnostics\n  - Instance DB created by FB_Diag\n  - Holds PLC_Heartbeat, PLC_Application_Version, PLC_Library_Version, IO_Module_Status[], Remote_Rack_Status[], HotStandby_Link_Status, timestamps\n\n- DB_Comms\n  - Instance DB created by FB_Comms\n  - Holds BMENOC0321_Status, SCADA_Heartbeat_Ack and any mapping descriptors\n\nNotes:\n- Instance DB names are authoritative. Naming must exactly match the list above (DB_Conveyor1 etc.) to ensure SCADA mappings and inter-block references are consistent.\n- When FBs are instantiated in TIA Portal, select the option to create the instance DB and then rename the DB to the exact name if the automatic name differs.\n\n---\n\n## Importing the generated code into TIA Portal and compiling successfully\n\nThis section walks through importing the SCL source files and creating blocks/UDTs/DBs in TIA Portal (V16/V17/V18 recommended for S7-1500). Follow steps exactly to avoid compile-time type resolution errors.\n\n1) Create a new TIA Portal Project\n   - Start TIA Portal and create a new project named ConveyorLine_Palletizer\n\n2) Add the target PLC device\n   - Insert a Siemens S7-1500 CPU that matches the target CPU model (ex: CPU 1516-3 PN/DP)\n   - Set the exact CPU firmware version in the device configuration to match the target hardware\n\n3) Create the UDTs (udt/*.scl)\n   - In PLC > Type System > Add User-Defined Data Types\n   - Create UDT_Device, UDT_Alarm, UDT_State with fields exactly as defined in udt/UDT_*.scl\n   - Ensure data types match (STRING length as required, ENUM definitions for mode and severity). Example ENUMs must be declared with the same enumerators as used by the FBs: CurrentMode {RUN_AUTO,RUN_MANUAL,STOP,HSBY_WAIT,MAINTENANCE,SIMULATION,ESTOP}; Alarm Severity {CRITICAL,MAJOR,MINOR}\n   - Save the UDTs\n\n4) Create FBs and copy SCL code\n   - For each FB in fb/ create a new FB in TIA Portal with the exact name (FB_ModeMgr, FB_Conveyor, FB_MergeDivert, FB_PalletizerHS, FB_AlarmMgr, FB_Diag, FB_Comms)\n   - Open the source SCL file from fb/ and paste the SCL implementation into the FB's SCL editor\n   - Define the FB interface variables (VAR_INPUT, VAR_OUTPUT, VAR_IN_OUT, TEMP) in the FB declaration exactly as the SCL uses them. Make sure public tags have comments (SCL supports comments per variable) describing their intent for SCADA and reviewer traceability\n\n5) Create OB100 and OB1\n   - Create OB100 (Organization block, type Cold Start) and paste ob/OB100.scl\n   - Create OB1 (Organization block, type Cyclic - 1ms/10ms as required) and paste ob/OB1.scl\n   - Set OB1 cycle time to reflect system deterministic schedule used by FB timers (documented in comments)\n\n6) Instantiate FBs and create instance DBs with exact names\n   - In Main [Program Blocks] create new block instances by placing each FB call inside an FC or directly in OB1 as structured code\n   - When creating an instance DB, give it the exact name required. Recommended names (must match):\n     - DB_ModeMgr\n     - DB_Conveyor1\n     - DB_MergeDivert1\n     - DB_PalletizerHS1\n     - DB_AlarmMgr\n     - DB_Diagnostics\n     - DB_Comms\n     - DB_SystemConfig\n   - After instantiation, open each DB and verify the structure matches the FB instance interface (all variables present and typed correctly)\n\n7) Create enums and data types referenced by FBs\n   - Create the ENUM types used by UDT_State and FB outputs (e.g., JamState ENUM {NO_JAM, SOFT_JAM, HARD_JAM}, HandshakeState ENUM etc.) in the Type System before compiling\n\n8) Add any necessary global constants/resources\n   - If FBs reference compile-time constants (timeouts, thresholds), either set them in DB_SystemConfig or as constants in the FBs. Ensure DB_SystemConfig exists and contains these values\n\n9) Compile order and first compile\n   - Build the project in the following order if manual compilation needed: Type System (UDTs/ENUMs) -> FBs -> OBs -> Instance DBs\n   - In TIA Portal use Project > Compile > Compile all to let the environment resolve cross-references\n\n10) Common compile issues and remedies\n   - Error: Unknown data type used by FB inputs/outputs -> ensure UDTs and ENUMs are created and saved before compiling FBs\n   - Error: Missing instance DB fields / size mismatch -> delete and recreate the instance DB from the FB or manually rename the auto DB to the authoritative name and ensure it contains same variables\n   - Error: Circular dependency between blocks -> ensure OB100 initializes global DBs only and does not call FBs that call OB100; keep OB100 for one-time init\n   - If code references STRING lengths not declared by UDT, set an adequate STRING length in the UDT definition\n\n11) Downloading and testing\n   - After a successful compile, download the program to the PLC\n   - Before placing the PLC in RUN, perform a controlled switch to STOP mode, read actual I/O states and confirm safety/ESTOP wiring\n   - Bring PLC to RUN only after verifying initial diagnostics in DB_Diagnostics\n\n---\n\n## E-Stop behavior, Reset Permissives and Safe State policies\n\n- E-Stop behavior (implemented in FB_ModeMgr and enforced by OB100 on cold start):\n  - When ESTOP condition is detected, FB_ModeMgr forces CurrentMode = ESTOP immediately and produces ModeChangeTimestamp\n  - All actuator outputs must be forced to a safe state when CurrentMode = ESTOP; FBs read CurrentMode and drive outputs accordingly (MotorCmd = FALSE, TransferStartCmd = FALSE, etc.)\n  - OB100 ensures the application initializes outputs to a defined safe state when cold-starting while an ESTOP condition is present\n\n- Reset and restoration to RUN_AUTO:\n  - A manual ResetPermissives boolean input must be asserted (acknowledgement of ESTOP by operator)\n  - FB_ModeMgr then re-evaluates each permissive (PLC_Health_OK, Power_Supplies_OK, HotStandby_Link_OK_or_StandbyReady, No_High_Severity_SIF_Trip, Operator_Authorised, Maintenance_Permit) and only transitions to RUN_AUTO when all required permissives are true\n  - This ensures that ESTOP requires both local manual acknowledgement and automated re-validation of system health before normal operation resumes\n\nComments in FB_ModeMgr SCL indicate which permissive corresponds to which UDT_State field so reviewers can trace the function back to the safety spec.\n\n---\n\n## SCADA tag mapping overview\n\nThis section provides the canonical SCADA to PLC tag mapping. SCADA integrators should use these PLC paths when configuring OPC UA or Modbus exposures. Where an array or structured type is listed, use the indicated index/field names.\n\nNote: All PLC DB names and field names are authoritative. Use the instance DB names exactly as listed in the Instance DBs section.\n\nSCADA tag mapping (SCADA tag -> PLC tag path [datatype])\n\n- PLC_Heartbeat -> DB_Diagnostics.PLC_Heartbeat [BOOL]\n- PLC_Application_Version -> DB_Diagnostics.PLC_Application_Version [STRING]\n- PLC_Library_Version -> DB_Diagnostics.PLC_Library_Version [STRING]\n- CPU_Redundancy_Status -> DB_Diagnostics.CPU_Redundancy_Status [STRING]\n- HotStandby_Link_Status -> DB_Diagnostics.HotStandby_Link_Status [BOOL]\n- HotStandby_Link_LastChange_Timestamp -> DB_Diagnostics.HotStandby_Link_LastChange_Timestamp [STRING]\n- Remote_Rack_Status[] -> DB_Diagnostics.Remote_Rack_Status[] [ARRAY OF WORD]\n- IO_Module_Status[] -> DB_Diagnostics.IO_Module_Status[] [ARRAY OF WORD]\n- Last_Switchover_Event -> DB_Diagnostics.Last_Switchover_Event [STRING]\n- Time_Sync_Status -> DB_Diagnostics.Time_Sync_Status [STRING]\n\n- Alarm_List[] -> DB_AlarmMgr.ActiveAlarms[] [ARRAY OF Alarm_DDT]\n- FirstOutAlarm -> DB_AlarmMgr.FirstOutAlarm [Alarm_DDT]\n\n- Conveyor1_MotorCmd -> DB_Conveyor1.MotorCmd [BOOL]\n- Conveyor1_JamState -> DB_Conveyor1.JamState [ENUM: NO_JAM/SOFT_JAM/HARD_JAM]\n- Conveyor1_ClearSequenceActive -> DB_Conveyor1.ClearSequenceActive [BOOL]\n\n- Merge1_RouteCmd -> DB_MergeDivert1.RouteCmd [STRING]\n- Merge1_RouteStatus -> DB_MergeDivert1.RouteStatus [ENUM: ROUTED/HOLD/ERROR]\n- Merge1_FallbackTimerActive -> DB_MergeDivert1.FallbackTimerActive [BOOL]\n\n- PalletizerHS1_State -> DB_PalletizerHS1.HandshakeState [ENUM]\n- PalletizerHS1_LastError -> DB_PalletizerHS1.LastError [STRING]\n\n- BMENOC0321_Status -> DB_Comms.BMENOC0321_Status [STRING]\n- SCADA_Heartbeat_Ack -> DB_Comms.SCADA_Heartbeat_Ack [BOOL]\n\nMapping details and notes:\n- Alarm_DDT mapping: SCADA systems that can import complex data types should map each Alarm_DDT field (Alarm_ID, Severity, Active, FirstOut, Timestamp, Latched, RequiresAck) to corresponding SCADA attributes\n- ENUMs should be exported as both numeric and textual representations if SCADA supports it. Use the enumerator names documented in the UDTs for textual faceplates.\n- For Modbus register mapping via FB_Comms, recommended approach:\n  - Pack boolean arrays into 16-bit Modbus coils or bits in registers\n  - Pack WORD arrays (IO_Module_Status, Remote_Rack_Status) directly to consecutive Modbus registers starting from a known base index (set Modbus_Map_Register_Start in DB_Comms / FB_Comms)\n  - Strings can be packed into consecutive registers using two bytes per character; ensure SCADA string decode matches PLC STRING format and declared length\n\nExample OPC UA node suggestions:\n- Use an object per instance DB (DB_Conveyor1) with variables mapped to fields within the DB\n- Provide historic timestamps (ModeChangeTimestamp, Alarm.Timestamp) as separate string nodes or as DateTime nodes if SCADA supports conversion\n\n---\n\n## Example SCADA mapping table (copyable)\n\n| SCADA Tag | PLC Tag Path | Data Type |\n|-----------|--------------|-----------|\n| PLC_Heartbeat | DB_Diagnostics.PLC_Heartbeat | BOOL |\n| PLC_App_Version | DB_Diagnostics.PLC_Application_Version | STRING |\n| CPU_Redundancy_Status | DB_Diagnostics.CPU_Redundancy_Status | STRING |\n| HotStandby_Link_Status | DB_Diagnostics.HotStandby_Link_Status | BOOL |\n| Alarm_List[0..n] | DB_AlarmMgr.ActiveAlarms[] | ARRAY of Alarm_DDT |\n| FirstOutAlarm | DB_AlarmMgr.FirstOutAlarm | Alarm_DDT |\n| Conveyor1_MotorCmd | DB_Conveyor1.MotorCmd | BOOL |\n| Conveyor1_JamState | DB_Conveyor1.JamState | ENUM |\n| Merge1_RouteCmd | DB_MergeDivert1.RouteCmd | STRING |\n| PalletizerHS1_State | DB_PalletizerHS1.HandshakeState | ENUM |\n| BMENOC0321_Status | DB_Comms.BMENOC0321_Status | STRING |\n\nThis table is intentionally explicit so SCADA integrators can create faceplates and data model nodes without ambiguity.\n\n---\n\n## Diagnostics, logging and versioning\n\n- OB100 populates DB_Diagnostics.PLC_Application_Version and PLC_Library_Version during cold start. These fields are intended for SCADA and asset management tagging.\n- FB_Diag publishes PLC_Heartbeat once per OB1 cycle and maintains HotStandby_Link_LastChange_Timestamp\n- FB_AlarmMgr sets FirstOutAlarm whenever a new highest-priority alarm is detected and maintains latching/ack policies\n\n---\n\n## Troubleshooting checklist\n\n- If an FB compiles but the project fails to compile: verify referenced UDTs/ENUMs exist and are saved\n- If SCADA shows empty or null string values for DB string fields: verify string length and that FB writes are performed (FBs may only update fields when in RUN and when permissives permit)\n- If outputs are not driven when expected after download: check CurrentMode in DB_ModeMgr and the ESTOP permissives. Many outputs are forced to safe state when CurrentMode = ESTOP\n- If Modbus/OPC mappings mismatch expected register offsets: verify DB_Comms.Modbus_Map_Register_Start and Modbus_Register_Count, and confirm endianness and coil/register packing conventions with SCADA\n\n---\n\n## Reviewability and traceability\n\n- Each public tag, DB field and UDT member must include an inline comment in its SCL/FB declaration explaining the functional spec traceability. For example, FB_ModeMgr.VAR_INPUT ModeCmd has a comment referencing the Mode transition table and the ESTOP recovery policy. Use consistent comment phrasing so reviewers can search for spec references.\n- The SCL files in fb/ and udt/ include these comments adjacent to each public variable (variable comments are visible in TIA Portal variable declaration and are encouraged for SCADA field descriptions).\n\n---\n\n## Change control and versioning\n\n- When updating FB interfaces, update the README and docs/Scada_Tag_Map.md and increment PLC_Application_Version in DB_Diagnostics during OB100 initialization\n- Keep changes backwards compatible for SCADA mappings where possible by adding new tags rather than renaming existing tags\n\n---\n\n## Contact and support\n\nFor questions about importing this project or mapping SCADA tags, contact the automation engineering owner (automation-team@example.com). Include the PLC model, TIA Portal version and a description of the problem. Attach export of the DB contents (XML or CSV) where possible.\n\n\n---\n\nRevision: 1.0 (ConveyorLine_Palletizer initial deliverable)\n\n"
}